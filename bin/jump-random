#!/usr/bin/env python

import random
import subprocess
from argparse import ArgumentParser
from pathlib import Path


def main():
    parser = ArgumentParser()
    parser.add_argument(
        "--kak", default=False, help="Open with kakoune", action="store_true"
    )
    args = parser.parse_args()

    kak = args.kak

    source_file = get_random_source_file()
    line_number = get_random_line_number(source_file)

    print(f"{source_file}:{line_number}")
    if kak:
        subprocess.run(["kak", "-e", f"edit -existing %[{source_file}]  {line_number}"])


def get_random_source_file():
    git_ls = subprocess.run(
        ["git", "ls-files"],
        capture_output=True,
        text=True,
        check=True,
    )
    sources = git_ls.stdout.splitlines(keepends=False)
    random_source = random.choice(sources)
    return Path(random_source)


def get_random_line_number(source_file: Path):
    lines = source_file.read_text().splitlines()
    return random.randint(1, len(lines) + 1)


if __name__ == "__main__":
    main()
